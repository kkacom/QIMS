package com.zhilian.rf_qims.mvp.sample_manager.view;


import android.annotation.SuppressLint;
import android.content.Intent;
import android.graphics.Color;
import android.graphics.drawable.ColorDrawable;
import android.support.v4.app.ActivityOptionsCompat;
import android.support.v7.widget.Toolbar;
import android.util.TypedValue;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.widget.AdapterView;

import com.baoyz.swipemenulistview.SwipeMenu;
import com.baoyz.swipemenulistview.SwipeMenuCreator;
import com.baoyz.swipemenulistview.SwipeMenuItem;
import com.baoyz.swipemenulistview.SwipeMenuListView;
import com.colin.utils.LogUtil;
import com.zhilian.rf_qims.R;
import com.zhilian.rf_qims.adapter.SampleAdapter;
import com.zhilian.rf_qims.base.BaseActivity;
import com.zhilian.rf_qims.dao.GreenDaoManager;
import com.zhilian.rf_qims.dao.SampleCheckDao;
import com.zhilian.rf_qims.dao.ScenePicDao;
import com.zhilian.rf_qims.dao.SignPicDao;
import com.zhilian.rf_qims.entity.Project;
import com.zhilian.rf_qims.entity.Sample;
import com.zhilian.rf_qims.entity.SampleCheck;
import com.zhilian.rf_qims.entity.ScenePic;
import com.zhilian.rf_qims.entity.SignPic;
import com.zhilian.rf_qims.mvp.sample_data.DataActivity;
import com.zhilian.rf_qims.mvp.sample_detail.view.SampleDetailActivity2;
import com.zhilian.rf_qims.mvp.sample_detail.view.SampleUpdateActivity;
import com.zhilian.rf_qims.mvp.sample_manager.presenter.SamplePresenter;

import java.util.ArrayList;
import java.util.List;

/**
 * Created by colin on 2018/2/6 10:34 .
 */

public class SampleManagerActivity extends BaseActivity implements ISampleView {
    private Toolbar mToolbar;
    private SwipeMenuListView mListView;

    private SamplePresenter mPresenter;
    private Project mProject;
    private List<Sample> mSamples = new ArrayList<>();
    private SampleAdapter mAdapter;

    private int currentPosition;//当前操作的标记

    SwipeMenuCreator creator = new SwipeMenuCreator() {

        @Override
        public void create(SwipeMenu menu) {
// create "delete" item
            SwipeMenuItem updateItem = new SwipeMenuItem(
                    getApplicationContext());
            updateItem.setTitle("更新");
            updateItem.setTitleSize(18);
            updateItem.setTitleColor(Color.WHITE);
            // set item background
            updateItem.setBackground(new ColorDrawable(Color.rgb(0x93,
                    0xe5, 0xe8)));
            // set item width
            updateItem.setWidth(dp2px(90));
            // set a icon
            //deleteItem.setIcon(R.drawable.ic_delete);
            // add to menu
            menu.addMenuItem(updateItem);
            // create "delete" item
            SwipeMenuItem deleteItem = new SwipeMenuItem(
                    getApplicationContext());
            deleteItem.setTitle("删除");
            deleteItem.setTitleSize(18);
            deleteItem.setTitleColor(Color.WHITE);
            // set item background
            deleteItem.setBackground(new ColorDrawable(Color.rgb(0xF9,
                    0x3E, 0x25)));
            // set item width
            deleteItem.setWidth(dp2px(90));
            // set a icon
            //deleteItem.setIcon(R.drawable.ic_delete);
            // add to menu
            menu.addMenuItem(deleteItem);
        }
    };


    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
        if (resultCode == 0x12) {
            mPresenter.loadLocalSamplesByPid(mProject.getId());
        }
    }

    @Override
    protected int loadLayoutResource() {
        return R.layout.activity_sample;
    }

    @Override
    protected void initView() {
        mListView = findViewById(R.id.list);
        mAdapter = new SampleAdapter(this, mSamples);
        mListView.setAdapter(mAdapter);
        mListView.setOnItemClickListener(new AdapterView.OnItemClickListener() {
            @SuppressLint("RestrictedApi")
            @Override
            public void onItemClick(AdapterView<?> adapterView, View view, int i, long l) {
                Intent intent = new Intent(SampleManagerActivity.this, DataActivity.class);
                intent.putExtra("project", mProject);
                intent.putExtra("sample", mSamples.get(i));
//				GlobalConstants.currentSample = mSamples.get(i);
                startActivityForResult(intent, 0x12, ActivityOptionsCompat.makeSceneTransitionAnimation(SampleManagerActivity.this).toBundle());
                //startActivity(intent, ActivityOptionsCompat.makeSceneTransitionAnimation(SampleManagerActivity.this).toBundle());
            }
        });
        mListView.setMenuCreator(creator);
        mListView.setOnMenuItemClickListener(new SwipeMenuListView.OnMenuItemClickListener() {
            @Override
            public boolean onMenuItemClick(int position, SwipeMenu menu, int index) {
                Sample sample = mSamples.get(position);
                switch (index) {
                    case 0:
//						Intent intent = new Intent(SampleManagerActivity.this,SampleDetailActivity2.class);
//						intent.putExtra("project",mProject);
//						intent.putExtra("sample",sample);
//						intent.putExtra("status",1);
//						startActivityForResult(intent,0x11,ActivityOptionsCompat.makeSceneTransitionAnimation(SampleManagerActivity.this).toBundle());

                        Intent intent = new Intent(SampleManagerActivity.this, SampleUpdateActivity.class);
                        intent.putExtra("project", mProject);
                        intent.putExtra("sample", sample);
//				GlobalConstants.currentSample = mSamples.get(i);
                        startActivityForResult(intent, 0x12, ActivityOptionsCompat.makeSceneTransitionAnimation(SampleManagerActivity.this).toBundle());
                        break;
                    case 1:
                        SampleCheck sampleCheck = GreenDaoManager.getInstance().getNewSession().getSampleCheckDao().queryBuilder().where(SampleCheckDao.Properties.Id.eq(sample.getId())).unique();
                        if (sampleCheck != null) {
                            GreenDaoManager.getInstance().getNewSession().getSampleCheckDao().delete(sampleCheck);
                        }
                        GreenDaoManager.getInstance().getNewSession().getSampleDao().delete(sample);

                        //删除样品图片
                        List<ScenePic> scenePics = GreenDaoManager.getInstance().getNewSession().getScenePicDao().queryBuilder().where(ScenePicDao
                                .Properties.Sid.eq(sample.getId())).list();
                        for (int j = 0; j < scenePics.size(); j++) {
                            GreenDaoManager.getInstance().getNewSession().getScenePicDao().delete(scenePics.get(j));
                        }
                        //删除签名图片
                        SignPic signPic = GreenDaoManager.getInstance().getNewSession().getSignPicDao().queryBuilder().where(SignPicDao
                                .Properties.Sid.eq(sample.getId())).unique();
                        if (signPic != null) {
                            GreenDaoManager.getInstance().getNewSession().getSignPicDao().delete(signPic);
                        }

                        mPresenter.loadLocalSamplesByPid(mProject.getId());
                        break;
                }
                return true;
            }
        });
        mPresenter = new SamplePresenter(this);
        Intent intent = getIntent();
        mProject = (Project) intent.getSerializableExtra("project");
        mPresenter.loadLocalSamplesByPid(mProject.getId());
        mToolbar = findViewById(R.id.toolbar);
        initToolBar();
        mToolbar.setTitle("委托编号 : " + mProject.getItemCode());
        mToolbar.setSubtitle("项目名称 : " + mProject.getItemName());
        mToolbar.setSubtitleTextColor(getResources().getColor(R.color.black));
    }

    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
        getMenuInflater().inflate(R.menu.sample_toolbar, menu);
        return true;
    }

    private void initToolBar() {
        setSupportActionBar(mToolbar);
        getSupportActionBar().setTitle("");
        mToolbar.setNavigationIcon(R.drawable.md_nav_back);
        mToolbar.setNavigationOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                finish();
            }
        });
        mToolbar.setOnMenuItemClickListener(new Toolbar.OnMenuItemClickListener() {
            @Override
            public boolean onMenuItemClick(MenuItem item) {
                switch (item.getItemId()) {
                    case R.id.add:
                        /**
                         * 1、添加项目
                         */
                        Intent intent = new Intent(SampleManagerActivity.this, SampleDetailActivity2.class);
//						intent.putExtra("status",0);
                        intent.putExtra("project", mProject);
                        startActivityForResult(intent, 0x11, ActivityOptionsCompat.makeSceneTransitionAnimation(SampleManagerActivity.this).toBundle());
                        break;

                    case R.id.select:
                        //presenter.updateViewData();//更新页数数据
                        break;

                }
                return true;
            }
        });
    }

    @Override
    public void loadCacheDataSuccess(List<Sample> list) {

//        if (null != mSamples) {
        mSamples.clear();
//        }
        for (int i = 0; i < list.size(); i++) {
            mSamples.add(list.get(i));
            LogUtil.e("date = " + list.get(i).getMadeDate());
        }
        mAdapter.notifyDataSetChanged();
    }

    @Override
    public void onRemoveSample() {
//		Toast.makeText(SampleManagerActivity.this, R.string.sample_remove, Toast.LENGTH_SHORT).show();
//		mSamples.remove(currentPosition);
//		mAdapter.notifyDataSetChanged();
    }

    private int dp2px(int dp) {
        return (int) TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_DIP, dp,
                getResources().getDisplayMetrics());
    }
}
